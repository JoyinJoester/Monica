# Vivo 设备密码保存问题解决方案

## 🔴 问题描述

**设备**: Vivo  
**现象**: 密码保存对话框弹出，点击"保存"按钮后没有反应  
**对话框文本**: "要将密码保存到 Monica 吗?"

## 🎯 问题分析

从截图看，保存对话框**已经成功弹出**，说明:
- ✅ `onSaveRequest` 已触发
- ✅ SaveInfo 配置正常
- ✅ Activity 启动成功
- ✅ BottomSheet 显示正常

**问题在于**: 点击"保存"按钮后的流程中断

## 🔍 可能的原因

### 1. Vivo 特殊权限限制 ⭐⭐⭐⭐⭐

**最可能的原因!** Vivo 系统对应用有严格的权限管理。

**需要检查的权限**:
- 自启动权限
- 后台运行权限
- 悬浮窗权限
- 修改系统设置权限

**解决方案**:
1. 打开 Vivo 设备的"i管家"
2. 进入"应用管理" → "权限管理"
3. 找到 Monica 应用
4. 启用以下权限:
   - ✅ 自启动
   - ✅ 后台运行
   - ✅ 悬浮窗
   - ✅ 其他所有权限

### 2. 按钮点击事件未触发 ⭐⭐⭐

**检查方法**: 运行诊断脚本查看是否有 "🔘🔘🔘 保存按钮被点击!" 日志

**如果没有此日志**:
- UI 层面的问题
- 按钮可能被遮挡
- 触摸事件被拦截

### 3. 保存流程异常中断 ⭐⭐⭐⭐

**检查点**:
1. 按钮点击 → onSave 回调是否执行?
2. savePassword() 方法是否开始执行?
3. 数据库插入是否成功?
4. onSaveCallback 是否被调用?
5. Activity 是否关闭?

### 4. 数据库权限问题 ⭐⭐

某些 Vivo 设备可能限制数据库操作

### 5. Vivo 系统优化干扰 ⭐⭐⭐⭐

Vivo 的"省电管理"、"内存清理"可能杀死后台进程

## 🛠️ 诊断步骤

### 步骤 1: 重新编译安装

```powershell
# 清理并重新编译
.\gradlew clean
.\gradlew assembleDebug

# 安装
adb install -r app\build\outputs\apk\debug\app-debug.apk
```

### 步骤 2: 运行 Vivo 专用诊断

```powershell
.\diagnose-vivo-save.ps1
```

### 步骤 3: 测试并观察日志

在设备上:
1. 打开任意应用的登录页面
2. 输入用户名和密码  
3. 点击登录
4. 等待保存对话框
5. 点击"保存"按钮
6. **仔细观察诊断脚本的输出**

### 步骤 4: 分析日志

**完整的成功流程应该看到**:

```
① 保存 Activity 启动
   → AutofillSaveTransparentActivity 启动

② BottomSheet 对话框显示
   → BottomSheet 已显示

③ 保存按钮被点击!
   → 🔘🔘🔘 保存按钮被点击!

④ onSave 回调开始执行
   → 开始密码保存流程

⑤ 密码保存到数据库成功!
   → ✅✅✅ 保存新密码成功!

⑥ onSaveListener 回调触发
   → 🎉🎉🎉 onSaveListener 回调触发!

⑦ Activity 关闭
   → Activity.finish() 已调用
```

**如果在某个步骤中断**:

| 中断位置 | 问题 | 解决方案 |
|---------|------|----------|
| ① 未出现 | Activity 未启动 | 检查 onSaveRequest |
| ② 未出现 | BottomSheet 未显示 | Fragment 事务问题 |
| ③ 未出现 | 按钮点击无效 | UI 问题或触摸被拦截 |
| ④ 未出现 | onSave 未调用 | 回调连接问题 |
| ⑤ 未出现 | 数据库保存失败 | 查看错误日志 |
| ⑥ 未出现 | onSaveListener 未触发 | 回调链断裂 |
| ⑦ 未出现 | Activity 未关闭 | finish() 被阻止 |

## 🎯 Vivo 特殊配置

### 必须的权限设置

**路径**: 设置 → 更多设置 → 权限管理 → Monica

1. **自启动权限**: 
   - i管家 → 应用管理 → 自启动管理 → Monica → 允许

2. **后台运行权限**:
   - i管家 → 应用管理 → 后台高耗电 → Monica → 允许后台高耗电

3. **悬浮窗权限**:
   - 设置 → 权限管理 → 悬浮窗 → Monica → 允许

4. **修改系统设置**:
   - 设置 → 权限管理 → 修改系统设置 → Monica → 允许

### 关闭省电优化

**路径**: 设置 → 电池 → 后台耗电管理

- 找到 Monica
- 选择"允许后台活动"

### 白名单设置

**路径**: i管家 → 应用管理 → 应用行为记录

- 将 Monica 添加到白名单
- 防止被系统自动清理

## 🔧 代码层面的改进

### 已添加的增强日志

现在代码中已经添加了详细的日志:

1. **按钮点击时**:
   ```kotlin
   android.util.Log.w("AutofillSave", "🔘🔘🔘 保存按钮被点击!")
   ```

2. **保存流程每一步**:
   ```kotlin
   1️⃣ 开始加密密码...
   2️⃣ 检查现有密码...
   3️⃣ 检查重复密码...
   4️⃣ 创建新密码条目...
   5️⃣ 插入数据库...
   6️⃣ 验证保存结果...
   ```

3. **Activity 生命周期**:
   ```kotlin
   Activity 启动
   BottomSheet 显示
   onSaveListener 触发
   Activity 关闭
   ```

### 可能需要的额外修复

如果诊断显示某个特定步骤失败,我会针对性地修复。

## 📱 测试建议

### 测试应用选择

**推荐测试顺序** (从简单到复杂):

1. **项目自带测试应用** (最佳):
   ```powershell
   .\gradlew :test-app:assembleDebug
   adb install -r test-app\build\outputs\apk\debug\test-app-debug.apk
   ```
   - 专门设计用于测试自动填充
   - 日志最详细
   - 最容易发现问题

2. **Chrome 浏览器**:
   - 访问任意网站的登录页面
   - 比如: https://github.com/login

3. **系统自带应用**:
   - 浏览器
   - 邮件客户端

4. **第三方应用**:
   - 微博
   - 知乎
   - 等

### 测试前的准备

1. ✅ 确保 USB 调试已启用
2. ✅ 确保 Monica 的自动填充服务已启用
3. ✅ 确保运行了诊断脚本
4. ✅ 确保给予了所有必要的权限

## 🚨 如果仍然失败

如果完成所有步骤后仍然无法保存，请提供:

1. **完整的日志输出** (诊断脚本的输出)
2. **具体在哪一步中断** (①-⑦)
3. **任何错误信息** (红色日志)
4. **Vivo 设备型号和系统版本**

然后我会针对性地修复代码。

---

**立即开始诊断**: `.\diagnose-vivo-save.ps1`
